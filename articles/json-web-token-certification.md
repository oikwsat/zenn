---
title: "JWT認証"
emoji: "✨"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: [jwt]
published: false
---

## JWT とは

JWT は HTTP ヘッダーやクエリパラメータに JSON データをうまく載せられるように

- JSON データを URL セーフする方法を規定したもの
- JSON データをコンパクトにする方法を規定したもの

:::details URL セーフとは？

- データを URL の一部として安全に使用できるようにすること
- URL で問題を引き起こす文字を避けるか特別な方法でエンコードする
- Base64URL エンコーディングを使い「+」「/」を「-」「\_」に置き換え「=」を省略
- これによりデータが URL や HTTP ヘッダー内で安全に転送可能になる

:::

つまり、**JSON ベースのデータを暗号化して作成される文字列**のこと。
認証や認可のための仕組みとして Web アプリケーションなどで用いられる技術。

![](https://storage.googleapis.com/zenn-user-upload/183efbbd3c2e-20231111.png)

:::message

- JWT 自体は認証や暗号化について何も規定していない
- JWT は HTTP ヘッダー内で JSON データを URL セーフかつコンパクトにするためのデータフォーマットに過ぎない
- アプリケーション間で認証データを交換する手段として JWT が便利であるため使用されるが JWT と認証は本来無関係

:::

#### JSON データを URL セーフする方法

- JSON データを BASE64URL エンコードする

:::details BASE64URL エンコード

### BASE64 エンコード

1. **定義**: バイナリデータを ASCII 文字列に変換するエンコーディング方式。
2. **使用文字**: A-Z, a-z, 0-9, それに加えて '+'（プラス）と '/'（スラッシュ）の 64 文字を使用。
3. **パディング**: 出力が 8 ビットの倍数になるように'='（イコール）でパディングされる。
4. **用途**: メールや Web など、テキストのみを扱う環境でバイナリデータを安全に扱うために使用。
5. **特徴**: '+'と'/'の使用により、URL やファイルシステムで問題を引き起こす可能性がある。

### BASE64URL エンコード

1. **定義**: BASE64 エンコードの URL およびファイル名に安全なバージョン。
2. **使用文字**: BASE64 エンコードと同じ A-Z, a-z, 0-9 を使用。ただし、'+'は'-'（ハイフン）に、'/'は'\_'（アンダースコア）に置き換えられる。
3. **パディング**: BASE64 と同様に'='でパディングされるが、URL での使用時にはパディングが省略されることが多い。
4. **用途**: URL やファイル名で安全に使用できるように設計されている。
5. **特徴**: URL やファイルシステムでの問題を避けるために、特定の文字が置き換えられている。

これらのエンコーディング方式は、データをテキスト形式で安全に転送・保存するために広く利用されている。
特に Web 開発やデータ交換の分野で重要な役割を果たす。
:::

#### JSON データをコンパクトにする方法

- よく使われるデータ項目の名称を省略形にすることで JSON のキー名を短くする

JWT の仕様として、以下の省略名が予約されている。

| 省略形 | 完全な名称      | 説明                          |
| ------ | --------------- | ----------------------------- |
| iss    | issuer          | トークンの発行者              |
| sub    | subject         | ユーザの識別子など JWT の主体 |
| aud    | audience        | JWT の受信者                  |
| exp    | expiration time | JWT の有効期限                |
| nbf    | not before      | JWT の有効開始日時            |
| iat    | issued at       | JWT の発行日時                |
| jti    | JWT ID          | JWT の一意な識別子            |

## JWT 用語「クレーム」

- JSON のキーと値のペアは JWT では「クレーム(Claim)」と呼ぶ
- キー名は「クレーム名」
- 値は「クレーム値」
- 先ほど挙げた `iss` や `sub` など JWT で予約されているクレーム名は「登録クレーム名(Registered Claim Names)」と呼ばれる
- JWT では必須とする登録クレームを規定しておらず、利用はすべて任意
- 必須とするクレームは JWT を利用するアプリケーション間で決める
- 登録クレーム以外にもアプリケーション間で利用する任意のクレームを JWT に含めることも可能

## JWS とは

- JWT は HTTP ヘッダーでの利用を前提とした JSON の表現方法を定めているがセキュリティは考慮していない
- データは Base64URL エンコードされており簡単にデコードして内容を見ることができる
- デコードしたデータは修正して再エンコードすることで改ざんが可能
- JWT の改ざんを防止するために JSON Web Signature(JWS)が存在する
- JWS は改ざんを防ぐのではなく改ざんされたことを検知する仕組み
- JWS は改ざん可能だが改ざんされた場合それを検知できる
- JWT の内容を暗号化する JSON Web Encryption(JWE)もある

## JWS の署名

- 改ざん防止で登場するのが暗号鍵を使ったデータの署名
- 暗号鍵を使った JWT の署名は以下の図をもとに説明する
- なお、説明は理解を容易にするため、暗号化する側と復号化する側の双方が同じ鍵を使う共通鍵方式(秘密鍵方式)を前提にする
- 公開鍵方式の説明は共通鍵で全体の仕組みを解説した後に簡単に行う

![](https://storage.googleapis.com/zenn-user-upload/8a7f2badc1b0-20231111.png)

- JWS のデータはヘッダー、ペイロード、シグニチャの 3 つから構成される

### ペイロード

- JWT のクレームセット

### ヘッダー

- ペイロードの種類や署名アルゴリズムを表明する
- ヘッダーに設定する JSON のキー名は JWS 仕様で複数定義されている
- 重要なキーは `alg` で、ヘッダーとペイロードをどのアルゴリズムで署名(暗号化)したかを表す
- `alg` がないとデータを受け取った側はどのアルゴリズムで検証(復号化)すればよいか分からないため、必須
- `typ` はペイロードのデータ種別を表すものとなるが、必須ではない
- JWS 仕様には他にもいくつかヘッダー項目が定義されているが、`alg` と `typ` の 2 つ以外はあまり目にすることはない

### シグニチャ

- BASE64URL エンコードされたヘッダーとペイロードに対し、以下の 2 つを使って署名(暗号化)した結果
  - ヘッダーの `alg` で指定したアルゴリズム
  - 暗号鍵

### JWS による署名手順

JWS は最終的に下記の手順で生成した 1 つの文字列となるが、この文字列を生成する手順を「JWS コンパクトシリアライゼーション」と呼ぶ。

1. ペイロードを BASE64URL エンコードする
2. ヘッダーを BASE64URL エンコードする
3. 1 と 2 の結果を `.` で繋ぐ
4. 3 の結果を暗号鍵と `alg`` に指定された方式で署名(暗号化)し、その結果をさらに BASE64URL エンコードする
5. (ヘッダー+ペイロード)と 4(シグニチャ)の結果を `.` で繋ぐ

- 重要なのは手順 4
- 4.で生成されたシグニチャは暗号化されているが、その中身はヘッダーとペイロードと同じに内容になっている
- したがって、シグニチャを復号化した場合、その結果は 1 文字も異なることなく 3 の手順で作成したものと一致する

### JWS の検証

![](https://storage.googleapis.com/zenn-user-upload/d67cb19f230c-20231112.png)

1. ヘッダーを BASE64URL デコードしてハッシュ化アルゴリズムを確認する
2. アルゴリズムと暗号鍵を使用して、BASE64URL エンコードされたヘッダとペイロードから署名を算出する
3. 送信されてきたトークンの署名部分を BASE64 デコードする
4. 2 で算出した署名と 3 でデコードした署名が同じ値かどうか検証する

- `.` で連結された文字列の 3 つ目の署名は、暗号鍵を持っていない限り中身を見ることができない
- しかし、ヘッダーとペイロードは BASE64URL デコードすれば簡単に中身を見ることができ、改ざんも可能
- 署名のハッシュ値を検証することで、送信されたトークンの改ざんチェックができるというわけ

## JWT と JWS

改めて用語を整理すると、

- **JWT（JSON Web Token）**
  - JWS によりエンコードされたクレームセット
  - JWS のペイロードに該当する
- **JWS コンパクトシリアライゼーション**
  - ヘッダー、ペイロード、署名（シグネチャ）を BASE64URL エンコードして `.` で連結すること
- **JWS（JSON Web Signature）**
  - JWT を JWS コンパクトシリアライゼーションしたもの
  - つまり JWS とは JWS コンパクトシリアライゼーションした次の文字列を指す
    ```
    BASE64URLエンコード(ヘッダー) + . + BASE64URLエンコード(ペイロード) + . + BASE64URLエンコード(シグニチャ)
    ```

RFC 的に JWS のデータ部に相当するものを JWT と呼ぶ定義となっている。
そのため、JWT や JWS の用語が混同してややこしくなる。
実際のところは、JWT は JSON の表現方式で、その JWT をセキュアにやり取りできるように JWS シリアライゼーションした文字列が JWS。
JWT は JWS に包括されるため、JWS のことを一般的に JWT として呼ぶことも多い。

## JWT による認証フロー

1. ユーザ登録・ログイン
   - クライアントがサーバに対し、認証情報を送信する
2. 認証とトークンの発行
   - サーバはユーザの認証情報を検証する
   - 認証が成功すると、サーバは JWT トークンを生成し、ユーザにレスポンスする
3. トークンを含んだリクエスト
   - クライアントから受け取ったトークンを HTTP リクエストのヘッダー含めて、サーバに送信する
4. トークンの検証とアクセス制御
   - サーバは受け取った JWT を検証し、有効であればリクエストされたリソースへのアクセスを許可する
   - 検証では、有効期限や署名の一致チェックを行う
   - 検証したトークンの有効・無効でリソースへのアクセス制御を行う

## 参考リンク

https://developer.mamezou-tech.com/blogs/2022/12/08/jwt-auth/

https://deecode.net/?p=1544

https://speakerdeck.com/melonattacker/jwtsekiyuriteiru-men

https://scgajge12.hatenablog.com/entry/jwt_security
