---
title: "フロントエンド開発における自動テストまとめ"
emoji: "🙆"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: [Typescript, React, Jest, nextjs, reacttestinglibrary]
published: false
---

## テストの目的

### 事業の信頼のため

- 経済的な影響を及ぼすバグを含めてしまった場合、信頼を取り戻すまでの活動に間接的な絵経済影響を及ぼす
- バグを含めてリリースしてしまうと、サービスに対するイメージが低下してしまう

### 健全なコードを維持するため

- プロジェクトの実装が進むと、似通った処理はモジュール化するなどといったリファクタリングを行う
- しかし、リファクタリングにより実装済みの機能に影響を及ぼす可能性があり、リファクタリングを見送ってしまう
- テストコードを書く習慣があると、リファクタリングの際に逐一既存実装が壊れていないか確認できる

### 実装品質に自信を持つため

- テストコードが書きづらいと感じたら、テスト対象に処理を詰め込み過ぎているサインかも
- テストを書くことで実装したコードの品質を見直す機会に繋がり、より良い実装へと導いてくれる

### 円滑なコラボレーションのため

- チーム開発において、開発生産性を高めるためにも実装コード意外に細く情報を残すことが大事
- テストコードは単純なテキストドキュメントよりも優れた補足情報
- テストには 1 つずつタイトルが与えられ、どのような機能・振る舞いを持つのかが記載されている
- 実装コードがテストの要件を満たしている限り、補足内容と実装内容が異なることはない
- 技術的な誤りがないかの確認だけでなく、要件を満たしているかの確認もできる

### リグレッションを防ぐため

:::details リグレッションとは？
あるソフトウェアの新しい機能追加やバグ修正が行われた際に、以前正常に動作していた機能が予期しない不具合を発生する現象のこと。
:::

- 細かくモジュール分割することで、モジュール単体の責務やテストはシンプルになる
- 一方で、モジュール同士の依存関係が発生し、依存先の変更によってリグレッションが発生しやすくなる

## フロントエンドテストの種類と範囲

Web アプリケーションコードは、以下にある様々なモジュールを組み合わせて実装する。

1. ライブラリが提供する関数
2. ロジックを担う関数
3. UI を表現する関数
4. Web API クライアント
5. API サーバー
6. DB サーバー

フロントエンドテストの自動テストを書くとき、1〜6 のうち「どこからどこまでの範囲をカバーしたテストであるか」を意識する必要がある。
Web フロントエンドにおけるテストの範囲は以下の 4 つに分類される。

### 静的解析

- TypeScript や ESLint による静的解析
- バグの早期発見には欠かせない
- 単一のモジュール内部検証だけでなく、2 と 3 の間、3 と 4 の間など**隣接するモジュール間連携の不整合**に対して検証する

### 単体テスト

- 2 のみ、3 のみ、といったように**モジュール単体が提供する機能**に着目したテスト
- テスト対象モジュールが、定められた入力値から期待する出力値が得られるかをテストする
- 独立した検証が行えるため、滅多に発生しないケース（コーナーケース）の検証に向いている

### 結合テスト

- 1〜4 まで、2〜3 までというように**モジュールをつなげることで提供できる機能**に着目したテスト
- 範囲が広いほどテスト対象を効率よくカバーすることができる
- 相対的にざっくりとした検証になる傾向がある

### E2E テスト

- 1〜6 を通し、ヘッドレスブラウザ+UI オートメーションで実施するテスト
- ユーザーがシステムを使用する場面を想定し、実際にシステムを操作してテストを行う
- システム全体を対象に行われるテストであるため、複数のコンポーネントやシステム間の相互作用を含む複雑なテストケースを扱うことができる
- そのため、より本物のアプリケーションに近いテストが可能

## 目的別のテスト分類

テストは目的によって**テストタイプ**に分類される。
テストタイプは検証目的に応じて設定され、テストタイプごとに適したテストツールが存在する。

### 機能テスト（インタラクションテスト）

- 開発対象の機能に不具合がないかを検証する
- Web フロントエンドにおける開発対象機能の大部分は、UI コンポーネントの操作（インタラクション）が起点になるため、インタラクションテストが機能テストそのものになる
- React などのライブラリで実装された UI コンポーネントにおいては、ブラウザなしでもインタラクションテストができる
  - **仮想ブラウザ**でテストを実行するため

:::details 実際のブラウザなしでも可能なインタラクションテストの例

- ボタンを押下すると、コールバック関数が呼ばれる
- 文字を入力すると、送信ボタンが活性化する
- ログアウトボタンを押下すると、ログイン画面に遷移する

![](/images/frontend-test-summary/specific-examples-of-interaction-testing-that-can-be-done-without-a-real-browser.png)

:::

- 実際のブラウザが必要な機能テストは、ヘッドレスブラウザ+UI オートメーションを使用する
- ブラウザ環境を忠実に再現する必要のある機能テストがある場合に選択する

:::details 実際のブラウザが必要なインタラクションテストの例

- 最下部までスクロールすると、新しいデータがロードされる
- セッションストレージに保存した値が復元される

![](/images/frontend-test-summary/specific-examples-of-interaction-tests-that-require-a-real-browser.png)

:::

### 非機能テスト（アクセシビリティテスト）

- 非機能テストのうち、心身特性に隔てのない製品を提供できているかという検証が**アクセシビリティテスト**
  - キーボード入力による操作が充実しているか？
  - 視認性に問題のないコントラスト比となっているか？
- アクセシビリティテストは検証項目によって適切なテストツールが異なる

:::details アクセシビリティテストの例

- チェックボックスとして、チェックできる
- エラーレスポンスが表示された場合、エラー文言が読み上げ対象としてレンダリングされる
- 表示している画面で、アクセシビリティ違反がないか調べる

![](/images/frontend-test-summary/accessibility-testing.png)

:::

### ビジュアルリグレッションテスト

- UI コンポーネントの外観が変化していないことを検証するテスト
- UI コンポーネントが変更された場合に、ビジュアルに何らかの問題が生じていないかを確認するために行う
- ヘッドレスブラウザに描画された内容をキャプチャし、キャプチャ画像を比較することで見た目のリグレッションが発生していないかを検証する
- ユーザー操作を与えたことにより変化した UI コンポーネントの画像比較も可能

:::details ビジュアルリグレッションテストの例

- ボタンの見た目にリグレッションがない
- メニューバーを開いた状態にリグレッションがない
- 表示された画面にリグレッションがない

![](/images/frontend-test-summary/visual-regression-test.png)

:::

## テスト戦略モデル

各種テストはいくつかの層に分類して考えることができる。
![](/images/frontend-test-summary/relationship-between-test-coverage-and-cost.png)

- 上層のテストは忠実性の高いテスト（本物に近いテスト）になる
- 上層のテストは実行するにあたり本物に近いテスト環境を揃える必要がある
  - テスト用に用意した DB サーバーを起動してセットアップするなど
- テストに必要なコストは開発に与える影響が大きく、開発者間で十分に検討する必要がある
- **コスト配分をどのように設計して最適化を行うか**が、テスト戦略最大の検討事項となる

### アイスクリームコーン型

![](/images/frontend-test-summary/ice-cream-cone.png)

- 上層のテストが多いモデル
- 戦略モデルのアンチパターン
- 運用コストが高く、稀に失敗する不安定なテストがより多くのコストを必要とする
- コストが高くなると、自動テストによって開発体験が著しく低下するという本末転倒な悪影響が生じる

### テストピラミッド型

![](/images/frontend-test-summary/test-pyramid.png)

- 下層のテストが多いモデル
- 安定した費用対効果の高いテスト戦略になる

### テスティングトロフィー型

![](/images/frontend-test-summary/testing-trophy.png)

- 「TestingLibrary」の開発者、KentC.Dodds.氏が提唱するテスト戦略モデル
- 最も比重を置くべきなのは**結合テスト**であるという主旨

フロントエンドが提供する機能は、ユーザー操作（インタラクション）を起点に提供される。
そのため、ユーザー操作を起点とした結合テストを充実させることこそが、より良いテスト戦略になるという意図がある。
