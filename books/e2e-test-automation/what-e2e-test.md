---
title: "E2Eテスト"
---

## E2E テストとは？

ユーザーの実際の使用シナリオに基づいて、アプリケーションの開始から終了までの全プロセスをテストする手法です。

:::details 全プロセスをテストする？？

Web アプリケーションは、以下にある様々なモジュールを組み合わせて実装されています。

1. ライブラリが提供する関数
2. ロジックを担う関数
3. UI を表現する関数
4. Web API クライアント
5. API サーバー
6. DB サーバー

E2E テストは、1〜6 までを「ヘッドレスブラウザ」+「UI オートメーション」の組み合わせを中心に構成されたテスティングフレームワークを用いて、検証します。

そのため、ブラウザ固有の API を使用したり、画面をまたぐ機能テストに向いている。

:::

## 特徴

1. **使用するインターフェースはユーザーインターフェース**
   - システムとしてユーザーに提供するものをテストする
2. **テストケースはユーザーストーリー**
   - ユーザーがその機能を用いて達成したいことをテストする
   - 技術的制約によってユーザーストーリー以外のものをテストすることもある
3. **テスト対象は完全に統合されたシステム全体**
   - マイクロサービスアーキテクチャの場合、全てのサービスが揃った完全な状態での動作を確認する
4. **想定されるバグは、「ユーザーストーリーそのものの失敗」**
   - 「ログイン出来ない」
   - 「商品がカートに入らない」

## メリット

ここでは、E2E テストを行うことによる利点を説明します。

### ① 幅広い用途に利用できる

単体テストや結合テストでは難しい、以下の検証を行うことができます。

1. **互換性の確認**
   E2E テストを使えば、様々なブラウザ、OS、デバイスでソフトウェアが正しく動作するかを効率的に確認できます。
   これを手動テストでやろうとすると、大きなコストが必要になります...
2. **「生きたドキュメント」として**
   E2E テストは、ソフトウェアの使い方や機能を示す「生きたドキュメント」として活用できます。
   テストコードを読むことで、システムの動作を理解できるのです。
   さらに、ソフトウェアが変更されると自動的にテストが失敗するので、ドキュメントの更新忘れを防げます。
3. **仕様の可視化**
   詳細な仕様書がない古いシステムや、急速に開発が進んでいるプロジェクトでは、E2E テストを使って現在の仕様を可視化できます。
   UI の操作を通じてシステムの振る舞いを記録することで、「動くドキュメント」を作成できるのです。
4. **システムの監視ツールとして**
   実際のユーザー操作を模したテストを定期的に実行することで、システムの健全性を常にチェックできます。
   新しい機能をリリースした直後など、システムの基本的な機能が正常に動作しているかを素早く確認したい場合にも有効です。

### ② ユーザーストーリーそのものをテストできる

E2E テストの大きな特徴は、ユーザーストーリーをそのままテストできる点です。
これは他のテストレベルではほぼ不可能な、E2E テスト独自の強みです。

ユーザーインターフェースを通じて実際のユーザー操作を再現することで、ソフトウェアが本当にユーザーの期待通りに動作するかを確認できます。
これにより、「**ユーザーストーリーの失敗**」という最も深刻なバグを発見することができます。

この特性は、開発者やテスターにとって重要な責任も伴います。E2E テストを適切に実施することで、「こんな簡単なことも見落としていたのか」という批判を避け、ユーザーの満足度を高めることができるのです。

## デメリット

E2E テストはいいことばかりではありません。
ネガティブな面やリスクについても説明しておきます。

### ① 自動化の難度と複雑性が高い

E2E テストの大きなデメリットの一つは、自動化そのものに必要な作業が複雑で、思わぬ落とし穴にはまりやすいことです。

#### E2E テスト自動化に必要な要素

そもそも、E2E テストを自動実行するには、最低でも以下の要素が必要になります。

1. **テスト対象のシステム**
   - システム全体が統合された状態
   - 実ユーザーが利用するのと同等の環境が必要
2. **クライアント**
   - ブラウザやモバイルデバイスなど
   - 場合によってはリアルデバイスではなく、エミュレーターなどで代替することも
3. **オートメーションツール**
   - ユーザーインターフェースを自動操作するためのツール
   - ブラウザなどのクライアントソフトウェア自身が提供している場合や、サードパーティのツールを利用する場合がある

テストのために多くの要素が必要となり、単体テストや結合テストと比べてもかなり複雑です...

#### 自動化する上での課題

複数の要素を連携してテストするため、様々なことを考慮する必要があります。

1. **ツールのバグによる影響**
   - クライアントやオートメーションツールのバグに遭遇する可能性がある
   - 例：Google Chrome を自動操作するための ChromeDriver
2. **多様な環境への対応**
   - 新しいブラウザや多種多様なブラウザをテストしたいという要求がある
   - これらの環境自体が抱える問題により、自動テストがうまく動かないケースが発生する
3. **エミュレーターやシミュレーターの利用**
   - クライアントやモバイルデバイスのエミュレーター/シミュレーターを利用する場合、これらがトラブルを引き起こす可能性がある
4. **システム外部への依存**
   - E2E テストはシステムを外から利用してテストする
   - 他のテストレベルとは異なり、システムの外に大きく依存するテスト
   - 実装における考慮事項が非常に多くなる
5. **セキュリティ設定などの考慮**
   - 開発中のシステム特有のセキュリティ設定など、特別な考慮事項が存在する可能性がある

E2E テストは他のテストレベルとは異なり、**システムの外に大きく依存する**テストです。
そのため、実装における考慮事項は多くなります。

![](https://storage.googleapis.com/zenn-user-upload/56a5276b8734-20240924.png =350x)

### ② テスタビリティへの配慮が難しい

E2E テストは、システム全体の「振る舞い」を検証する強力なツールですが、同時にテスタビリティに関して特有の課題を抱えています。

#### 内部状態の取得の難しさ

E2E テストは主にシステム全体の外部から観察可能な振る舞いに焦点を当てますが、特定の条件下での動作を検証するために、やむを得ずシステム内部の状態を取得する必要が生じる場合があります。
しかし、E2E テストにおいてこのような内部状態の取得を実装することは以下の懸念点があります。

- システムの内部構造に深く依存するテストコードを書く必要があり、保守性が低下する
- テスト用の特別なインターフェースや機能を追加する必要があり、本番環境との乖離が生じる可能性がある
- 内部状態の取得自体がシステムの挙動に影響を与え、テスト結果の信頼性を損なう可能性がある

この問題により、複雑な条件や状態遷移を伴うテストシナリオの実装は難しいのです...

#### モックとスタブの利用制限

単体テストや統合テストでは、モックやスタブを使用してテスト対象を分離し、特定の条件下での動作を検証することが一般的です。
しかし、E2E テストではこれらの技法の使用には以下の懸念点があります。

- 実際の環境での動作を検証するという E2E テストの本質的な目的と相反する
- システム全体の統合状態を正確に反映できなくなる可能性がある

外部のサードパーティ API を利用する場合を例にすると以下のようなトレードオフを考慮する必要があります。

1. **実際の API を使用する場合**
   - テストの信頼性が向上する
   - しかし、API の動作や可用性に依存してテストが不安定になる可能性がある
   - コストやレート制限の問題が発生する可能性がある
2. **API をモック化する場合**
   - テストの安定性と再現性が向上する
   - しかし、「完全に統合された状態のシステムのテスト」という E2E テストの本来の価値が損なわれる
   - 実際の環境で発生する可能性のある問題を見逃す危険性がある

### ③ 高コスト

E2E テストの実施にはコストがかかります。

1. **時間的なコスト**
   - 本物のブラウザやモバイルデバイスなどを利用するため、起動やページロードも含め、実行時間が長くなります
   - ログインが必要なシステムでは、テストケースの度にログイン処理が必要になり、実行時間が長くなる可能性があります
2. **金銭的なコスト**
   - 環境やデバイスの数に比例して金銭的コストが増加します
   - 完全に統合された状態でシステムを起動する必要があるため、場合によっては本番環境と同等の環境を準備する必要があります

## E2E テストの導入前に考えること

E2E テストによる恩恵は大きいですが、一方で導入ハードルはとても高いです。
では、どのようなことを考慮して E2E テストを開始していけばよいのでしょうか？
