---
title: "pnpm"
---

## pnpm とは？

- Node.js のパッケージマネージャーの一つ
- npm や Yarn と同様の基本機能を持ちながら、独自のアプローチでパッケージ管理を行い、効率性と速度を追求している

## 特徴

1. 効率的なストレージ管理とインストールの高速化
2. 厳格な依存関係管理
3. 高速インストール
4. モノレポ対応
5. npm、yarn との互換性

## 効率的なストレージ管理

pnpm の最も特徴的な機能の一つが、その効率的なストレージ管理システムです。これは「コンテンツアドレス可能ストレージ」と呼ばれる手法を基にしています。

### コンテンツアドレス可能ストレージ

コンテンツアドレス可能ストレージとは、データの内容自体に基づいてストレージ内の位置を決定する方式です。pnpm の場合、これは以下のように機能します：

1. パッケージのコンテンツに基づいてユニークなハッシュを生成
2. このハッシュを使用してストレージ内の場所を決定
3. 同一のパッケージは常に同じ場所に保存される

この方式により、pnpm は重複を効果的に排除し、ストレージを最適化します。

### グローバルストア（.pnpm-store）

pnpm のグローバルストアは、通常`.pnpm-store`というディレクトリ名で作成されます。

#### 場所

- Linux/macOS: `~/.pnpm-store`
- Windows: `%LOCALAPPDATA%/pnpm/store`

#### 構造

グローバルストア内の構造は以下のようになっています：

```
.pnpm-store/
  v3/
    files/
      [hash1]
      [hash2]
      ...
    metadata/
      [package-name]@[version]
```

- `files/`: 実際のパッケージコンテンツが保存される
- `metadata/`: パッケージのメタデータ情報が保存される

#### 役割

1. パッケージの一元管理：すべてのプロジェクトで使用されるパッケージを一箇所で管理
2. 重複排除：同じパッケージは 1 回だけ保存される
3. バージョン管理：異なるバージョンの同じパッケージも効率的に管理

### 2.1.3 ハードリンクとシンボリックリンク

pnpm は、グローバルストアと各プロジェクトの`node_modules`をつなぐためにハードリンクとシンボリックリンクを使用します。

#### ハードリンク

- 定義：同じ i ノード（ファイルシステム上のデータの実体）への複数の参照ポイント
- 使用目的：グローバルストア内のファイルを各プロジェクトの`node_modules`から直接参照するために使用
- 利点：
  1. ディスク容量の節約：実体は 1 つだけで済む
  2. パフォーマンス：ファイルコピーが不要なため、インストールが高速

#### シンボリックリンク

- 定義：別のファイルやディレクトリへの参照（ショートカットのようなもの）
- 使用目的：`node_modules`のトップレベルに直接の依存関係を配置するために使用
- 利点：Node.js のモジュール解決アルゴリズムとの互換性を保つ

### 2.1.4 実際の`node_modules`構造

pnpm によって作成される`node_modules`の構造は以下のようになります：

```
node_modules/
  .pnpm/
    foo@1.0.0/
      node_modules/
        foo/ (ハードリンク)
        bar/ (ハードリンク)
    bar@1.0.0/
      node_modules/
        bar/ (ハードリンク)
  foo (シンボリックリンク → .pnpm/foo@1.0.0/node_modules/foo)
```

この構造により：

1. 直接の依存関係（foo）にはトップレベルからアクセスできる
2. 間接的な依存関係（bar）は適切に隔離される
3. すべてのファイルは実質的にグローバルストアを参照している

### 2.1.5 ストレージ管理の利点

1. ディスク容量の大幅な節約

   - 例：100 個のプロジェクトが lodash を使用していても、1 つのコピーだけが保存される

2. インストールの高速化

   - 既にストアにあるパッケージは、ダウンロードではなくリンク作成だけで済む

3. オフライン作業のサポート

   - 一度ダウンロードしたパッケージは、インターネット接続なしで再利用できる

4. バージョン管理の簡素化

   - 同じパッケージの異なるバージョンも効率的に管理される

5. ファイルシステムの整合性
   - ハードリンクにより、パッケージの内容が不意に変更されるリスクが低減する

### 2.1.6 注意点と考慮事項

1. ファイルシステムの制限

   - ハードリンクは同一ファイルシステム上でのみ機能する
   - 異なるドライブ間では機能しない

2. 権限の問題

   - グローバルストアへのアクセス権限が必要

3. クリーンアップ

   - 不要になったパッケージを削除するには`pnpm store prune`コマンドを使用する

4. バックアップと移行

   - グローバルストアのバックアップや移行時は、整合性に注意が必要

5. CI/CD 環境での扱い
   - CI/CD 環境では、プロジェクト固有のローカルストアを使用することが推奨される場合がある

pnpm のこの効率的なストレージ管理システムは、特に大規模プロジェクトや多数のプロジェクトを扱う開発環境で大きな利点をもたらします。ただし、その特殊な構造ゆえに、従来の npm や yarn とは異なる考慮事項も存在します。適切に理解し活用することで、開発効率と資源利用の大幅な改善が期待できます。
