---
title: "ロードバランサー"
---

## ロードバランサーとは

- クライアントからのリクエストを複数のサーバに分散させるための仕組みのこと
- Web サーバにかかる負担を減らして、大量のリクエストを捌くための方法として以下の 2 つがある
  - スケールアップ
  - スケールアウト
    詳しくは[こちら](https://zenn.dev/yuu104/books/web-technology-textbook/viewer/faster-and-larger-scale-web-systems)
- スケールアウトはスケーラビリティや耐障害性で有利であるが、クライアントからのリクエストを複数のサーバに分散させるための特別な仕組みが必要になる
- この仕組みを可能にするのが**ロードバランサー（負荷分散装置）**

![](https://storage.googleapis.com/zenn-user-upload/dedfa6d69fe3-20230730.png)

- ロードバランサーには Web サーバにインストールして利用するものから、専用機器まで数多くある
- 専用機器を使用したロードバランサーのメリット
  - 専用機器は、Web サーバのフロントエンドに設置することができるため、サーバ構成を大きく変える必要がない
  - 専用に設計されているため、専門的なチューニングをする必要もない

## ロードバランサーの負荷分散方式

![](https://storage.googleapis.com/zenn-user-upload/736bbbc87bb4-20230730.png)

### ラウンドロビン方式

- 単純に順番通りに各サーバに割り振る

### 優先順位方式

- 各オリジンサーバに**優先順位（Priority）**を設定し、優先順位の高いサーバからリクエストを割り振る
- 一定数割り振ったら、次に優先順位の高いサーバに割り振る
- 優先順位が低いオリジンサーバは、アクセスが集中した場合のみ利用する
- 優先度を最も低いサーバには、「アクセス集中のため表示できません」などの Web ページを用意しておき、アクセスが集中していることを告知するために利用したりする

![](https://storage.googleapis.com/zenn-user-upload/e7c3138a9236-20230730.png)

### 重み付け方式

- 割り当てるオリジンサーバの頻度を**重み（Raito）**で変えることができる
- オリジンサーバの性能に差がある場合、低スペックなサーバへの割り振りは減らし、高スペックなサーバへの割り振りは増やすなどの対応が可能
- 高スペックなサーバに対する重みを「3」、低スペックなサーバに対する重みを「１」に設定することで、アクセスを「3:1」の割合で割り振ることができる

![](https://storage.googleapis.com/zenn-user-upload/64c1b5814cd3-20230730.png)

### 状況に応じた動的な分散

- ラウンドロビン方式は、あらかじめ設定した通りに動作する**静的**なもの
- しかし、ロードバランサーには状況に応じて動的に動作する分散方式もある
- 動的な分散では、応答速度、トラフィック量、コネクション数、CPU 負荷などのパラメータを元に、ロードバランサーがその都度判断して設定を決定する
- **最速応答時間方式**、**最小コネクション方式**、**最小トラフィック方式**は、動的な分散方式

![](https://storage.googleapis.com/zenn-user-upload/96489329d093-20230730.png)

- 動的な負荷分散では、**ヘルスチェック機能**でオリジンサーバをモニタリンングする
- モニタリングデータはロードバランサー内部に保持する必要がある
- そのため、ロードバランサーの仕組みが複雑になり、より高性能なロードバランサーが必要になる

![](https://storage.googleapis.com/zenn-user-upload/457f52e5d111-20230730.png)

- ロードバランサーによっては複数の方式を組み合わせることが可能
  - 最速応答時間方式と最小コネクション方式を組み合わせることで、よりサーバの負荷状況を反映させた設定が可能

## コンテンツスイッチング

- HTTP ヘッダーやリクエストメッセージの中身によって割り振りを変更できる
  - URL に「img」が含まれている場合はサーバ 1、拡張子が「.php」の場合はサーバ 2 に割り振るなど
- 画像うあ HTML などの静的コンテンツ専用のオリジンサーバと、Web アプリケーション専用のオリジンサーバに分けて運用することも可能

![](https://storage.googleapis.com/zenn-user-upload/9bcc27356c8c-20230730.png)

- コンテンツスイッチング方式では、**HTTP リクエスト**に含まれる URL、言語、クッキーなど、様々な属性を割り振るための条件を指定できる
- そのため、コンテンツスイッチング方式は**L7 スイッチ**とも呼ばれている
