---
title: "セッションハイジャック"
---

## セッションハイジャックとは？

第三者がセッション ID を悪用して正規ユーザに成りすますこと。
第三者がセッション ID を知るための手段は 3 種類に分類される。

- セッション ID の推測
- セッション ID の盗み出し
- セッション ID の強制

## セッションハイジャックの手法

![](https://storage.googleapis.com/zenn-user-upload/ab0f7eb15106-20240211.png)

セッションハイジャックの原因となる脆弱性は多様。
それぞれの脆弱性に個別対応していく必要がある。

### セッション ID の推測

- セッション ID の生成方法が不適切な場合、利用者のセッション ID を第三者が推測でき、セッションハイジャックが可能になる可能性がある
- 不適切な例としては
  - 連番
  - 日時を元にする
  - ユーザ ID を元にする
- OSS などのセッション ID の生成ロジックが公開されている場合は、ロジックからセッション ID を推測される危険性がある

### セッション ID の盗み出し

手法としては以下の通り。

- クッキー生成の際の属性の不備により漏洩する
- ネットワーク的にセッション ID が盗聴される
- XSS などのアプリケーション脆弱性により漏洩する
- 開発言語やブラウザなどプラットフォームの脆弱性により漏洩する
- セッション ID を URL に保持している場合は、`Refer` ヘッダから漏洩する

セッション ID の盗み出しが可能なアプリケーションの脆弱性は以下がある。

- XSS
- HTTP ヘッダ・インジェクション
- URL に埋め込まれたセッション ID

### セッション ID の強制（セッション ID の固定化攻撃）

- セッション ID を盗む代わりに、セッション ID を利用者のブラウザに設定する
- 攻撃者は利用者のセッション ID を「知っている」状態になり、セッションハイジャックが可能になる

## セッションハイジャックの影響

- 利用者の重要情報（個人情報、メールなど）の閲覧
- 利用者の持つ権限での操作（送金、物品購入など）
- 利用者の ID によるメール、ブログなどへの投稿、設定の変更

## 推測可能なセッション ID

### 攻撃手法

以下の 3 ステップで攻撃する。

1. 対象アプリケーションからセッション ID を集める
2. セッション ID の規則性の仮説を立てる
3. 推測したセッション ID を対象アプリケーションで試す

### 影響

- 攻撃者は、成りすましに成功した状態では、以下のようなアプリケーションが持つ機能を利用者の権限により全て利用できる
  - 重要情報の閲覧
  - データや文書の投稿・更新・削除・物品の購入・送金
- しかし、閲覧に先立ってパスワードの再入力が必要なページについては悪用できない
- セッションハイジャックでは、利用者のパスワードまでは分からない
- 重要な処理の前にパスワードの再入力（再認証）を要求すると、保険的な対策になる

### 脆弱性が生まれる原因

- **セッション管理機構をアプリケーション側で自作すること**
- 以下の理由からセッション ID の生成ロジックを自作する必要はない
  - 主要なフレームワーク・ライブラリがセッション管理機構を備えている
  - 安全なセッション ID 生成ロジックを実装することは技術的難易度が高

### ありがちなセッション ID 生成方法

セッション ID の生成には以下を元にする場合が多い。

- ユーザ ID やメールアドレス
- リモート IP アドレス
- 日時（UNIX タイムの数値、あるいは年月日時分秒の文字列）
- 乱数

上記そのままをセッション ID として利用する場合もあるが、複数の組み合わせやエンコード処理、ハッシュ値が利用される場合もある。

![](https://storage.googleapis.com/zenn-user-upload/ec5e2a38b2c0-20240211.png)

ユーザ ID や日時は外部から推測可能な元データなので、脆弱性の原因になる。

### 対策

- 主要なフレームワーク・ライブラリが提供するセッション管理機構を利用する
- どうしても自作する必要がある場合は、暗号論的擬似乱数生成器を元に、十分な桁数の ID を生成する

### まとめ

![](https://storage.googleapis.com/zenn-user-upload/adecd7c6e0e3-20240211.png)

## URL 埋め込みのセッション ID

- セッション ID をクッキーに保存せず、URL に埋め込ませる場合がある
- PHP や Java、ASP.NET は、セッション ID を URL に埋め込む機能をサポートしている
- 以下は具体例
  `http://example.jp/mail/123?SESSID-2F3BE9A31F093C`
- セッション ID を URL に埋め込んでいると、`Referer` ヘッダを経由して、セッション ID が外部に漏洩し、成りすましの原因になる場合がある

### Referer によりセッション ID が漏洩する条件

- URL 埋め込みのセッション ID を使える
- 外部サイトへのリンクがある。あるいはリンクを利用者が作成できる。
  - 外部サイトは悪意のあるサイト
  - `Referer` からセッション ID を盗む

### 攻撃手法

- `Referer` からのセッション ID 漏洩は、「事故として漏れるケース」と「意図的な攻撃として脆弱性が狙われるケース」がある
- 外部から意図的に攻撃を仕掛けることができるのは、**利用者がリンクを作成できるようなサイト**に限る
  - 掲示板、Web メール、ブログ、SNS など
- Web メールからの攻撃例は以下の通り

1. 攻撃者がターゲットに対して、URL つきのメールを送信する
   - メールには、「私のホームページを見てください」などの言葉で、攻撃者のサイトに誘導する
2. 利用者は誘導に釣られて攻撃者のリンクを踏む
3. 攻撃者のサイトから `Referer` ヘッダー経由でセッション ID が漏洩する

![](https://storage.googleapis.com/zenn-user-upload/ae42dce4dc58-20240212.png)

### 脆弱性が生まれる原因

- 不適切な設定・プログラミングが原因
- URL 埋め込みのセッション ID は、意図的に設定しているケースと、不注意による設定のケースが存在する
- 意図的に設定する理由は以下の 2 つ
  - 2000 年前後に主にプライバシー上の理由から「クッキー有害論」が起こり、クッキーを避けようという機運が一部にあった
  - NTT ドコモの携帯電話ブラウザが過去にクッキーに対応していなかったので、携帯電話向けの Web アプリは URL 埋め込みのセッション ID が主流だった

### 対策

- セッション ID を URL 埋め込みにしないように設定・実装する
- クッキーにセッション ID を保存するようにする

### まとめ

![](https://storage.googleapis.com/zenn-user-upload/324b4af0c425-20240212.png)

## セッション ID の固定化
