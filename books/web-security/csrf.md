---
title: "CSRF（クロスサイト・リクエストフォージェリ）"
---

## CSRF とは

- ユーザが信頼しているサイトに対して、外部から不正なリクエストを送信する攻撃手法
- ユーザのブラウザからリクエストが発生し、「重要な処理」を実行させられる

:::details 重要な処理とは？
ログインした利用者のアカウントにより実行される、取り消しできないような処理。
例えば、

- 利用者のクレジットカードでの決済
- 利用者の口座からの送金
- メール送信
- パスワードやメールアドレスの変更

:::

- CSRF 脆弱性の影響は、アプリケーションの「重要な処理」の悪用に限られる
- Web API でも CSRF 脆弱性が混入する場合がある

## 攻撃手法と影響

![](https://storage.googleapis.com/zenn-user-upload/f445dd71bb9d-20240131.png)
*https://www.ipa.go.jp/security/vuln/websecurity-HTML-1_6.html*

攻撃の理解にあたっては、特に以下について注目するとよい

- 対象の Web サイトのユーザが、正規の手順でログイン済であることを前提とする
  - **ログイン済 ≒ ユーザの Web ブラウザにセッション Cookie が発行されている**ことがポイント
    - したがって、Web サイトへのユーザーとしてのログイン有無自体は関係がない（後述）
- 対象の Web サイトが、設計上意図しない更新操作を受け付けてしまうことで攻撃が成立する
  - **受け付けてしまう ≒HTTP リクエストがバックエンドで処理される**ことがポイント
    - したがって、HTTP リクエストに対するレスポンスがどのような結果となったかは関係がない
    - Web ブラウザに不正なレスポンスが表示されることで発生する攻撃は XSS のように別の攻撃として分類される

## 具体例

CSRF 攻撃の一般的な例を説明する。
この例では、オンラインバンキングサイトにログインしているユーザーを対象とし、攻撃者がユーザーの銀行口座から自分の口座に不正にお金を振り込むシナリオを想定する。

1. **ターゲットのログイン**
   - ユーザー（被害者）が銀行のウェブサイトにログインし、セッションが開始される
   - セッション ID はクッキーに保存される
2. **攻撃者の準備**
   - 攻撃者は、銀行のサイトで送金を行うリクエストを模倣した HTML フォームを作成する
   - このフォームは、攻撃者の口座にお金を送るように設定されている
   - 例として、フォームの内容は以下の通り
     ```html
     <form action="https://bank.example.com/transfer" method="POST">
       <input type="hidden" name="amount" value="1000" />
       <input type="hidden" name="account" value="攻撃者の口座番号" />
     </form>
     ```
   - 攻撃者が用意したフォームは、ターゲットとなるサイト（この場合は銀行のサイト）に実際に存在するフォームの構造を模倣している
   - CSRF 攻撃では、攻撃者はターゲットのサイト上で行われる通常のリクエストの形式を知っている必要がある
3. **攻撃者のリンク配布**
   - このフォームを含むウェブページを攻撃者が作成し、メールやソーシャルメディアを通じてターゲットにリンクを送る
4. **ユーザーのクリック**
   - ユーザーがそのリンクをクリックし、ページを開くと、JavaScript を使用して自動的にフォームを送信する
5. **不正なリクエストの送信**
   - ユーザーのブラウザは、フォームのデータと共にユーザーのセッションクッキーも銀行のサーバーに送信する
   - 銀行のサーバーはこのリクエストを正規のユーザーのリクエストと誤認識する
6. **不正な取引の実行**
   - 銀行のサイトはリクエストを処理し、ユーザーの口座から攻撃者の口座に 1000 ドルを振り込む

注目ポイントは、

- この攻撃はユーザーが銀行のサイトにログインしている間にのみ機能する
- 攻撃者はユーザーのセッション ID やパスワードを知る必要はない
- ユーザーがリンクをクリックするだけで攻撃が実行される
- 攻撃によってパスワードが変更される場合は、情報漏洩も...

## CSRF と XSS の比較

![](https://storage.googleapis.com/zenn-user-upload/51a7a7a735aa-20240131.png)

- CSRF は ③ のリクエストに対するサーバ側の処理を悪用するもの
  - 悪用内容はサーバ側で用意された処理に限定される
- XSS では、④ のレスポンス内容に含まれる、悪意あるスクリプトがブラウザ上で実行されることにより攻撃される
  - ブラウザ上でできることは何でも可能
- 攻撃の広範さという点では XSS の脅威の方が大きい

## 脆弱性が生まれる原因

CSRF 脆弱性が生まれる背景として、以下の Web の性質がある。

1. **`form` 要素の `action` 属性にはどのドメインの URL でも指定できる**
   - `form` の `action` 属性には、リクエストを送信するサーバーの URL を指定する
   - この URL は、現在のドメインと異なる（外部の）ドメインでも構わない
   - この性質を悪用すると、攻撃者は自分のコントロール下にあるサイトから、正規のサイトへのリクエストを送信できる
2. **クッキーに保管されたセッション ID は、対象サイトに自動的に送信される**
   - ユーザーがサイトにログインすると、その認証情報（例えばセッション ID）はクッキーに保存される
   - ブラウザは同じサイトへの後続のリクエストに対して、これらのクッキーを自動的に付加して送信する
   - これによりユーザーは再ログインすることなくサイトを利用できる
   - しかし、これが CSRF の脆弱性を生む
   - ユーザーが攻撃者の準備したページを訪れた際に、そのページから正規のサイトにリクエストが送られると、ユーザーのブラウザは自動的にそのユーザーのセッションクッキーをリクエストと共に送信する
   - 正規のサイトはこのリクエストを正当なユーザーからのものと誤認し、攻撃者の意図する不正な行動を実行してしまう

これらの Web の性質が組み合わさることで、CSRF 攻撃が可能になり、サイトはこの種の攻撃からユーザーを守るために追加のセキュリティ措置を講じる必要がある。

## 正常なリクエストと CSRF 攻撃によるリクエストはほとんど変わらない

以下は、正常なリクエストと CSRF 攻撃によるリクエスト。

**正常なリクエスト**

```
POST /transfer HTTP/1.1
Host: bank.example.com
Cookie: sessionid=123456789
Referer: https://bank.example.com/transfer
Content-Type: application/x-www-form-urlencoded
Content-Length: ...

amount=1000&account=recipient_account_number
```

**CSRF 攻撃によるリクエスト**

```
POST /transfer HTTP/1.1
Host: bank.example.com
Cookie: sessionid=123456789
Referer: https://evil.example.com/attack-page
Content-Type: application/x-www-form-urlencoded
Content-Length: ...

amount=1000&account=attacker_account_number
```

- 両者を比較すると、HTTP リクエストの内容はほとんど同じ
- `Referer` ヘッダのみ異なる
- `Referer` 意外はクッキーも含めて同じ
- よって、アプリケーション側で `Referer` ヘッダをチェックしない限り、両者は区別できない

## 対策
