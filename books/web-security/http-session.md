---
title: "HTTPとセッション管理"
---

## Basic 認証

https://qiita.com/ooo-lang/items/f067c34146f889179652

## クッキーとセッション管理

https://www.engilaboo.com/definitely-understand-cookie-session/

### アプリケーションデータを保持する目的でクッキーに値を入れない

理由は、

- Cookie が保持できる値の個数や文字列長には制限がある
- Cookie の値は参照・変更できるので機密情報の保持には向かない

じゃあどうするの？

→ 「整理番号」としてのセッション ID を Cookie に保持しておき、実際の値はサーバ側に置いておく

### セッション管理の擬人的な説明

![](https://storage.googleapis.com/zenn-user-upload/ee84fc8b463a-20231126.png)

### セッション ID に求められる要件

1. **第三者がセッション ID を推測できないこと**
   - ID となる乱数の質が問題になる
   - 乱数に規則性があると、セッション ID を収集することで他者のセッション ID が推測できる場合がある
   - セッション ID は暗号論的疑似乱数生成器を用いて生成する
   - 実際の開発には、セッション ID を自作せず、開発ツールで提供されるものを利用すべき
2. **第三者からセッション ID を強制されないこと**

   - セッション ID の固定化攻撃と呼ばれる手法
   - 攻撃者がユーザーのセッションを乗っ取るために行われる一種のセッションハイジャック攻撃
   - この攻撃では、攻撃者がユーザーに対して、特定のセッション ID を持つ URL をクリックさせたり、セッション ID を強制的に設定させたりすることを試みる
   - 具体的な仕組み
     1. 攻撃者がユーザーに対して悪意のあるリンクを送信し、そのリンク内に特定のセッション ID を含める
     2. ユーザーがリンクをクリックすると、攻撃者が用意したセッション ID がユーザーのブラウザに保存される
     3. ユーザーがアプリケーションにアクセスする際、ブラウザは攻撃者が用意したセッション ID を自動的に送信し、サーバーはその ID を認識する
     4. これにより、攻撃者はユーザーのセッションを乗っ取り、ユーザーのアカウントやデータにアクセスできるようになる
   - 対応策
     - 認証後にセッション ID を変更する

   https://www.ubsecure.jp/blog/session_fixation

3. **第三者にセッション ID が漏洩しないこと**
   セッション ID が漏洩する原因は、
   - クッキー発行の際の属性に不備がある
   - ネットワーク的にセッション ID が盗聴される
   - クロスサイト・スクリプティングなどアプリケーションの貧弱性により漏洩する
   - PHP やブラウザなどのプラットフォームの貧弱性により漏洩する
   - セッション ID を URL に保持している場合は、Refer ヘッダから漏洩する

## クッキーの属性

クッキーを発行する際には、様々なオプションの属性を設定することができる。
| 属性 | 意味 |
| ---- | ---- |
| Domain | ブラウザがクッキー値を送信するサーバのドメイン |
| Path | ブラウザがクッキー値を送信する URL のディレクトリ |
| Expires | クッキー値の有効期限。指定しない場合はブラウザの終了まで |
| Secure | HTTPS の場合のみクッキーを送信 |
| HttpOnly | この属性が指定されたクッキーは JavaScript からアクセスできない |

セキュリティ上重要な属性は、`Domain`、`Secure`、`HttpOnly`。

### Domain 属性

- クッキーはデフォルトではクッキーを発行したサーバにのみ送信される
- 複数のサーバに送信されるクッキーを生成したい場合もあるため、この時に `Domain` 属性を使用する

![](https://storage.googleapis.com/zenn-user-upload/bb34d19a2528-20231216.png)

- `Domain=example.jp` の指定があるので、`a.example.jp` と `b.example.jp` にクッキーが送信される
- 一方、`a.example.com` はドメインが異なるので送信されない
- **`Domain` 属性は発行サーバと同一ドメイン or サブドメインのみ指定できる**
- そのため、`a.example.jp` サーバが Set-Cookie の際に、`Domain=example.com` としても、このクッキーはブラウザに無視される
- 異なるドメインに対するクッキーが設定できると、前述のセッション ID の固定化手法として利用されるので、異なるドメインに対するクッキー設定はできないように制限されている
- `Domain` 属性を不用意に設定すると、貧弱性の原因になる

:::message
**クッキーの `Domain` 属性は原則として設定しない**
:::

### Secure 属性

- `Secure` 属性をつけたクッキーは、HTTPS 通信の場合のみサーバに送信される
- `Secure` 属性をついていないクッキーは、常にサーバに送信される
- `Secure` 属性はクッキーの HTTPS 送信を保証する目的で指定される

### `HttpOnly` 属性

- JavaScript からアクセスできないクッキーを設定するもの
- クッキーとして格納されたセッション ID を盗み出す攻撃例は、クロスサイト・スクリプティング攻撃
- これは JavaScript によりクッキーを盗み出す手法
- `HttpOnly` 属性はクロスサイト・スクリプティング攻撃を完全に防ぐことはできないが、攻撃を難しくすることは可能
- `HttpOnly` 属性をつけることによる悪影響はないので、基本は設定する
