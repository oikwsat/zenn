---
title: "論理設計とパフォーマンス"
---

## 正規化のデメリット

- 正規化のメリットは、**データの整合性を保持できる**こと
- デメリットは、**正規化されたテーブル群に対する 検索 SQL が非常に遅くなり、パフォーマンスが劣化する**こと
- **SQL における結合は非常にコストの高い操作**
- 結合するテーブル数、及びレコード数が増えれば増えるほど処理時間が増す
- 正規化によるパフォーマンス劣化の原因の多くは、SQL の結合操作

### 正規化と SQL（検索）

以下の第３正規化されたテーブル群を例に考える。
![](https://storage.googleapis.com/zenn-user-upload/498287138710-20231021.png)

#### 社員名が「田島」の会社名を取得する

SQL で取得するステップは

1. `社員` テーブルから `社員名` を検索条件として検索する
2. 検索にヒットした社員データの `会社コード` を使用して、`会社` テーブルから `会社名`　を検索条件として検索する

- `社員` テーブルと `会社` テーブルの２つのテーブルを検索対象とすることになる
- よって、SQL で 2 つのテーブルを結合する必要がある
  - 結合キーは `会社コード`

```sql
SELECT 会社.会社名,
       社員.社員名
  FROM 社員 INNER JOIN 会社
              ON 社員.会社コード = 会社.会社コード
  WHERE 社員.社員名 = "田島";
```

結果

```
会社名 社員名
----- -----
B科学  田島
```

#### 会社名が「田島」の会社名と部署名を取得する

```sql
SELECT 会社.会社名,
       社員.社員名
       部署.部署名
  FROM 社員 INNER JOIN 会社
              ON 社員.会社コード = 会社.会社コード
            INNER JOIN 部署
              ON 社員.部署コード = 部署.部署コード
  WHERE 社員.社員名 = "田島";
```

結果

```
会社名 社員名 部署名
----- ----- -----
B科学  田島   開発
```

#### 会社ごとに何人いるかを集計する

```sql
SELECT 会社.会社コード,
       COUNT(社員.社員名) AS 社員数
       部署.部署名
  FROM 会社 LEFT OUTER JOIN 社員
              ON 社員.会社コード = 会社.会社コード
  GROUP BY 会社.会社コード;
```

結果

```
会社コード 社員数
-------- -----
C0001    3
C0002    3
C0003    0
```

- 正規化されたテーブルでは、単独のテーブルでは全てのデータをカバーして取得できない
- それは、正規化が情報を複数のテーブルに分散させる行為だから

#### 非正規化による解決

- 正規化を捨てれば、テーブル結合を行わずにデータを取得できる

第 2 正規化する前の `社員` テーブル

| 会社コード | 会社名 | 社員 ID | 社員名　 | 年齢 | 部署コード | 部署名 |
| ---------- | ------ | ------- | -------- | ---- | ---------- | ------ |
| C0001      | A 商事 | 000A    | 中島     | 40   | D01        | 開発   |
| C0001      | A 商事 | 000B    | 藤本     | 32   | D02        | 人事   |
| C0001      | A 商事 | 001F    | 三島     | 50   | D03        | 営業   |
| C0002      | B 科学 | 000A    | 斉藤     | 47   | D03        | 営業   |
| C0002      | B 科学 | 009F    | 田島     | 25   | D01        | 開発   |
| C0002      | B 科学 | 010A    | 渋谷     | 33   | D04        | 総務   |

このテーブルを使用すれば、「田島さんの会社と部署名」を取得するにあたり、結合を使用せずに済む。

```sql
SELECT 会社名,
       社員名,
       部署名
  FROM 社員
 WHERE 社員名 = "田島"
```

正規化したテーブル群における SQL と比較すると、シンプルになっている。
また、テーブルの結合を行っていないため、パフォーマンスが良い。

### 正規化と SQL（更新）

**更新処理に関しては、正規化の方がパフォーマンスが良い。**

会社名を更新する場合を考える。

#### 正規化しない場合

第 2 正規化する前の `社員` テーブル

| 会社コード | 会社名 | 社員 ID | 社員名　 | 年齢 | 部署コード | 部署名 |
| ---------- | ------ | ------- | -------- | ---- | ---------- | ------ |
| C0001      | A 商事 | 000A    | 中島     | 40   | D01        | 開発   |
| C0001      | A 商事 | 000B    | 藤本     | 32   | D02        | 人事   |
| C0001      | A 商事 | 001F    | 三島     | 50   | D03        | 営業   |
| C0002      | B 科学 | 000A    | 斉藤     | 47   | D03        | 営業   |
| C0002      | B 科学 | 009F    | 田島     | 25   | D01        | 開発   |
| C0002      | B 科学 | 010A    | 渋谷     | 33   | D04        | 総務   |

上記テーブルの `会社名` を更新する。

```sql
UPDATE 社員
   SET 会社名 = "E物産"
 WHERE 会社コード = "C0001";
```

会社コードが `C0001` のレコードすべてに対し、更新処理を行う必要がある。

#### 正規化した場合

**`会社`テーブル**
| 会社コード | 会社名 |
| ---------- | ------ |
| C0001 | A 商事 |
| C0002 | B 科学 |

```sql
UPDATE 会社
   SET 会社名 = "E物産"
 WHERE 会社コード = "C0001";
```

- 正規化した場合は、`社員` テーブルと `会社` テーブルに分かれている
- `会社名` を更新する場合、`会社` テーブルの１レコードに対して更新処理を行えばいい

### 正規化と非正規化、どちらが正解なのか？

- 正規化と検索 SQL のパフォーマンスは強い**トレードオフ**の関係

![](https://storage.googleapis.com/zenn-user-upload/ca0be6f44d0e-20231021.png)

#### 結局どっちなの？

- **原則として非正規化は許さない**

> 本節を次の論理的な意見で締めくくりたいと考えているが、それは今まで聞いたことがないものかもしれない。それは、「非正規化」はあくまでも最後の手段であるという姿勢でのぞむ、というものだ。要するに、十分に正規化された設計をあきらめてもよいのは、パフォーマンスを向上させるためのその他すべての戦略が要件を満たさない場合だけである。

- 非正規化は最後の手順
- 最初は必ず正規化する
- 非正規化以外でパフォーマンス向上が図れないかを検討する
