---
title: "バックアップ設計"
---

- 障害等によってデータが失われたときに、復旧できるような設計をバックアップ設計によって行う
- 主要バックアップは下記の 3 種類
  1. フルバックアップ（完全バックアップ）
  2. 差分バックアップ
  3. 増分バックアップ
- DB のバックアップ設計においては、3 つの方式を組み合わせていく
  - どれか 1 つだけ、ということは普通ない

## フルバックアップ

- 名前の通り
- ある時点で保持されている全てのデータをバックアップする
- バックアップ時点のデータを全て復旧することが可能

![](https://storage.googleapis.com/zenn-user-upload/3fa604bcc3d3-20230917.png)

- 上記の場合、日曜に障害が発生すると、土曜にバックアップしたデータで復旧する

- シンプルである一方、欠点もある
  - バックアップの時間が（他に比べて）長い
  - ハードウェアリソースへの負荷が（他に比べて）高い
  - サービス停止が必要

## 差分バックアップ

- 特定日だけフルバックアップし、それ以外は差分だけをバックアップする

![](https://storage.googleapis.com/zenn-user-upload/3209911a5240-20230917.png)

- 上記の場合、
  - 月曜日だけフルバックアップ
  - 火〜日は、月曜日からの**変更分だけ**をバックアップ

### どのように差分管理をするのか？

- **ログファイル**を使用する
- ログファイルは、データ変更の一時格納ファイル
- ログファイルをバックアップすることで、**DB に対する変更操作を再現することが可能になる**

- 最新データを復旧するのに必要なのは「① + ⑥」
- 変更ログだけでは復旧できないため、元データの ① は必要
- ②〜⑤ の内容は、⑥ に含まれるため、必要ない

### メリット

- バックアップのデータ量が減る
- バックアップファイルを保管しておく容量を節約できる

### デメリット

- リカバリの手順が増えて時間がかかる
  - フルバックアップのファイル「①」だけでなく、差分ログの「⑥」も必要になる
- リカバリには複数のファイルが必要になるため、どちらか一方が壊れると復旧できなくなる

## 増分バックアップ

- 差分バックアップの冗長性を省き、効率化したもの

![](https://storage.googleapis.com/zenn-user-upload/c21bebf5b409-20230917.png)

- 差分バックアップでは、最新のログファイルが古いログファイルの内容も包含していた
- 増分バックアップでは、前回ログからの差分のみをバックアップする
- 従って、復旧時には ①〜⑥ の全てのファイルが必要になる

### メリット

- バックアップデータ量が最小になる
- バックアップに要する時間が最短
- バックアップファイルを保管する容量が最小
- コスト的には最も優れている

### デメリット

- リカバリ手順が最も複雑になる
- 復旧に必要なファイルが多いため
- 完全に復旧できる可能性が最も低い

## バックアップ方式のトレードオフ

![](https://storage.googleapis.com/zenn-user-upload/f3ca497a54d1-20230917.png)

- **バックアップコストが低いほどリカバリコストは高い**

## どのバックアップ方式を採用すべきか？

- **それぞれの利点と欠点を比較検討し、システムの特性に応じて選択する**
- 考慮すべきポイント
  1. いつの時点の状態に復旧させる必要があるか？そもそも復旧の必要はあるか？
  2. バックアップに使用できる時間（バックアップウィンドウ）
  3. リカバリに使用できる時間（リカバリウィンドウ）
  4. 何世代までのデータを残す必要があるか？（保管用の媒体サイズに影響）
- バックアップ設計の選択肢
  1. バックアップしない
  2. フルバックアップのみ
  3. フルバックアップ + 差分バックアップ
  4. フルバックアップ + 増分バックアップ
- 基本的には、以下の選択
  - フルバックアップ + 差分バックアップ
  - フルバックアップ + 増分バックアップ
