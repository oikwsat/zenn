---
title: "ビュー"
---

## ビューとは？

- テーブルから `SELECT` してきた取得結果や複数テーブルを結合した結果を、仮想的なテーブルとして作成する手法
- 「仮想的なテーブル」とある通り、通常作成されるテーブルとは違い、実態はない
- `SELECT` 文の結果に対し、名前をつけて保存したもの
- ビュー作成の構文は以下の通り

```sql
CREATE VIEW ビュー名 AS SELECT文
```

- 元のテーブルが更新されると、ビューも自動で更新される
- ビューに対して SQL を実行することも可能

```sql
SELECT
    *
FROM
    test_view
WHERE
    age = 20;
```

## メリット

### `SELECT` 文を何度も書く必要がなくなる

- テーブルの結合など、複雑な `SELECT` 文をビューとして保存しておけば、何度も書かなくて済む
- 効率よくデータの取得ができる

### 容量を圧迫しない

- ビュー自体が `SELECT` 文なので、データを保存しない
- テーブルよりも容量を圧迫しない

## デメリット

## パフォーマンスの低下

- ビューは `SELECT` 文が書かれたファイルにすぎない
- ビューに対し、SQL 文によってアクセスが行われたとき、ビューは定義されている `SELECT` 文を実行し、オリジナルのテーブルにアクセスしている
  - オリジナルのテーブルを「**基底テーブル**と呼ぶこともある）
- よって、ビューへアクセスするときは、2 段階の SQL が発行されている

![](https://storage.googleapis.com/zenn-user-upload/76a8cb05961a-20231029.png)

- 厳密には、DBMS 内部は可能な限り ① と ② の `SELECT` 文をマージして、効率の良い形で実行する
- ただ、「① + ②」によって生まれる SQL 文の方が ① よりも高コスト

### 多段ビューの危険性

![](https://storage.googleapis.com/zenn-user-upload/9c2774ab0cd6-20231029.png)

- T1〜T3 はテーブル、V1〜V6 はビュー
- V6 のビューへアクセスする場合、最終的には合計 4 つの `SELECT` 文が内部的に必要になる
- V6 へアクセスする処理全体として考えた場合、パフォーマンスを悪くする
- また、階層の深いビュー定義は、テーブルとビューの依存関係をわかりにくくするため、仕様が複雑になり管理が困難
- 設計したエンジニアですら何のために作ったビューなのか分からなくなり、同じようなビューが乱立する可能性もある

:::message
**多段ビューは危険。**
**ビューの使用は原則として 1 段にとどめる。**
:::

## マテリアライズド・ビュー

- `SELECT` 文の結果をキャッシュとして保持する
- ビューとの異なり、データの実態を持つ
- 作成する構文は以下の通り

```sql
CREATE MATERIALIZED VIEW マテリアライズド・ビュー名 AS SELECT文
```

### メリット

#### 処理が高速

- ビューと違って、実態のデータを持つため、SQL の展開コストがない

#### 主キーやインデックスが作成できる

- 主キーを用いての検索やデータ重複を防げる
- インデックスの作成により、ビューに比べて高速に検索が可能

### デメリット

#### 最新データを取得するにはリフレッシュが必要

- データの実態があるため、元テーブルの更新に伴い、同期のためのリフレッシュ処理が必要
- リフレッシュを行わないと、最新データとのズレが生じてしまう
- リフレッシュするのは以下の SQL を実行する

```sql
REFRESH MATERIALIZED VIEW マテリアライズドビュー名
```

#### ストレージ容量を消費する

- 通常のテーブルと同様にストレージを消費する
- むやみやたらに作成すると、容量を圧迫してしまうので注意
