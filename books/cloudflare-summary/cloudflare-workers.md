---
title: "CloudFlare Workers"
---

## 概要

- エッジサーバでスクリプトを実行してくれるサーバーレスコンピューティングであり、FaaS
- Web リクエストに応じたレスポンスを返すサービスを簡単に構築できる
- Workers は世界中に配置されたエッジサーバで実行されるため、クライアントからの要求に高速に応答することができる
- Azure Functions や AWS Lambda と同じようなサービス
- JavaScript（V8）を実行することが可能

## サーバレスコンピューティングとは？

https://www.cloudflare.com/ja-jp/learning/serverless/what-is-serverless/
https://qiita.com/takanorig/items/3a3a0b43b5be5b4a124f
https://www.science.co.jp/document_jamstack_blog/30226/

## FaaS とは？

https://www.cloudflare.com/ja-jp/learning/serverless/glossary/function-as-a-service-faas/

クラウドコンピューティングの一種。
アプリケーションの機能や処理を個別の関数（コードの断片）として実行できるようにするサーバレスアーキテクチャ。
つまり、アプリケーションを小さな関数の集まりとして構築し、それぞれの関数が特定のタスクや処理を担当する。
開発者はコードを記述し、クラウドプロバイダーが関数の実行環境を提供し、必要なときに関数をスケーリングする。

### 特徴

- **サーバレス**
  開発者はサーバの管理を行う必要がない。
- **イベント駆動**
  関数はトリガーに応じて自動的に実行され、イベント駆動型のアーキテクチャをサポートする。
- **瞬時のスケーリング**
  高負荷時に自動的に関数のインスタンスを増減させ、スケーリングが簡単。
- **従量課金**
  実際に使用したリソースに対して課金されるため、コスト効率が高い。
- **複数の言語サポート**
  多くの FaaS プラットフォームは複数のプログラミング言語をサポートし、開発者が選択肢を持てる。

### ユースケース

#### 画像のリサイズ

1. ユーザが Web アプリに画像をアップロードする
2. 画像のアップロードがトリガーとなり、サーバレス関数が実行される
3. サーバレス関数は、アップロードされた画像をリサイズし、異なる解像度のバージョンを生成する
4. ユーザにリサイズされた画像が表示される

このケースでは、アプリの一部であるリサイズ機能をサーバレス関数として実装し、必要なときにトリガーされるようにしている。

#### データの処理と通知

1. センサーやデバイスからリアルタイムのデータが収集される
2. データの到着がトリガーとなり、サーバレス関数が呼び出される
3. サーバレス関数はデータを解析し、特定の条件に合致する場合に通知を生成する。
   例えば、温度が一定以上に上昇した場合に警告通知を生成することができる。
4. 通知が適切な受信者に送信される

このケースでは、データの処理と通知をサーバレス関数として分離し、データが到着したときに関数が実行されるようにしている。

#### バックエンド API の処理

1. クライアントからの HTTP リクエストがアプリケーションのバックエンドに送信される
2. リクエストの到着がトリガーとなり、FaaS 関数が実行される
3. サーバレス関数はリクエストを処理し、データベースからデータを取得したり、認証を行ったり、他のビジネスロジックを実行する
4. 関数は HTTP レスポンスを生成してクライアントに返す

このケースでは、バックエンド API の各エンドポイントをサーバレス関数として実装し、リクエストごとに適切な関数が実行される。

### メリット

- **コスト効率**
  従量課金なので、実際に使用したリソースに対してのみ支払いが発生する。
- **スケーラビリティ**
  自動的にスケーリングするため、トラフィックの変動に適応できる。
- **高可用性**
  クラウドプロバイダーが冗長性を提供し、高可用性を実現する。
- **簡素化された運用**
  サーバーの管理やメンテナンスが不要で、運用コストが低い。

### デメリット

- **コールドスタート**
  関数が初めて実行される際に遅延が発生することがあり、一部のアプリケーションに影響を与えることがある。
- **制約**
  メモリや実行時間の制約があるため、一部のタスクには適していない場合がある。
- **リプレイスが困難**
  サーバレスアーキテクチャはベンダーごとにやり方が異なる。

## CloudFlare Workers の特徴

- JS のコードをデプロイするだけでサーバサイド機能が構築できる
- 負荷に応じて自動的にスケーリングされ、常に安定して処理される
- 常時起動されているわけではなく、呼び出しに応じて起動される
- 使用量に応じた従量課金ではあるが、ある程度までは無料で使える

上記のように、従来の FaaS と同様な部分もありつつ、似て非なる点もいくつかある。

以下は CloudFlare Workers の大きな特徴。

### 全世界の CDN エッジで実行される

- 従来の FaaS では、書いたコードを事業者のどのリージョンにデプロイするかを、最初に決める必要があった
- 例えば、東京リージョンにデプロイした場合、日本国内では速く応答できるが、東京から遠いブラジルなどはレイテンシーが高くなる
- しかし、CloudFlare Workers では、[世界 100 ヵ国 200 以上の拠点](https://www.cloudflare.com/network/)に配置された CDN のエッジにデプロイされ、常にアクセスした場所の最寄りの拠点で実行される
- これにより、サーバからの物理的位置が原因のレイテンシー問題が解消される

### Service Workers のような使い方もできる

- ブラウザにおける Servece Workers のような使い方ができる
- Servece Workers は、「目的のリソースを取得するためのリクエストがネットワークに出ていく直前」で任意の処理を差し込めるレイヤー
  ![](https://storage.googleapis.com/zenn-user-upload/c142abfa062d-20231001.png)
  そのため、

  - 発行されたリクエストを加工する
  - レスポンスをキャッシュしておいて、次からネットワークアクセスを省略する処理

  などが可能となる。

- これに対し、CloudFlare Workers では、「発行されたリクエストが目的のリソースに届く直前」で任意の処理を実行できる
  ![](https://storage.googleapis.com/zenn-user-upload/f1453b9177ff-20231001.png)
  そのため、

  - リソースを加工してレスポンスを返す
  - リダイレクトするなど、そもそものアクセスを禁止
  - AB テストによるコンテンツの出し分け

  というように、CDN 本来のキャッシュ機能をプログラムを介して柔軟に利用できる。

### Node.js ではない JavaScript の実行環境

- CloudFlare Workers の実行環境は、JavaScript の実行エンジにである V8
- これにより、従来の FaaS で問題になっていたコールドスタートが短くなり、安定して高速な応答ができるようになる
- V8 のアップデートは頻繁に行われるため、いつでも最新の JavaScript が使用できる
-

<!-- ## 開発環境の構築

まずは、node.js をインストールする
`v16.13.0` より新しいバージョンの node が必要になる

```shell
& node --version
v18.17.0
```

## サインアップ

https://workers.cloudflare.com/

- CloudFlare のアカウントを作成する
- 無料で使える Free プランが用意されている
- クレジットカードの登録は不要 -->

## ユースケース

エッジサーバにてコードを実行するので、オリジンサーバに到達する前に実行したい独自処理を得意とする。

- 異なるタイプのリクエストを異なるオリジンサーバにルーティングする
- HTML テンプレートをエッジで展開し、オリジンでの帯域幅の費用を削減する
- キャッシュコンテンツに対する独自コントロール
- User-Agent ごとにリダイレクト
- 全く異なる 2 つのバックエンド間で A/B テストを実現
- 独自のアクセスフィルタリング
- 独自のフェイルオーバーの実装
- ログの収集

上記のように活用方法は様々。
公式サイトに example がある。
https://developers.cloudflare.com/workers/examples

### 利用例

https://product.st.inc/entry/2022/12/20/112524#f-a70ec28d

## 参考リンク

https://www.codegrid.net/articles/2021-cloudflare-workers-1/

https://qiita.com/sakupa80/items/8ccb4e4e4c0f7846ab5c

https://zenn.dev/moutend/articles/97c98a277f4bae#cli%E3%83%84%E3%83%BC%E3%83%AB

https://reffect.co.jp/html/cloudflare-workers/
